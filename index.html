<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
<title>å¤§é¥¼å¼€è½¦å•¦ï¼</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
html, body { width: 100%; height: 100%; overflow: hidden; background: #000; font-family: 'PingFang SC', 'Heiti SC', sans-serif; touch-action: none; user-select: none; -webkit-user-select: none; }

/* ========== é€‰è½¦ç•Œé¢ ========== */
#selectScreen {
    position: fixed; inset: 0;
    display: flex; flex-direction: column; align-items: center;
    background: linear-gradient(180deg, #FFE066 0%, #FF9A56 50%, #FF6B9D 100%);
    z-index: 10;
    overflow-y: auto; -webkit-overflow-scrolling: touch;
    padding: 4vmin 0 6vmin;
}
#selectScreen.hidden { display: none; }

.select-title {
    font-size: 10vmin; font-weight: 900; color: #fff;
    text-shadow: 0 0.5vmin 1vmin rgba(0,0,0,0.2);
    margin-bottom: 3vmin;
    animation: titleBounce 1.5s ease-in-out infinite;
}
@keyframes titleBounce {
    0%, 100% { transform: translateY(0) scale(1); }
    50% { transform: translateY(-1.5vmin) scale(1.05); }
}

.select-subtitle {
    font-size: 4.5vmin; color: rgba(255,255,255,0.9); margin-bottom: 4vmin;
}

#vehicleGrid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 3vmin;
    padding: 2vmin;
    width: min(92vw, 90vh);
}

.vehicle-card {
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    background: rgba(255,255,255,0.92);
    border-radius: 4vmin;
    padding: 3vmin 2vmin;
    cursor: pointer;
    transition: transform 0.15s ease;
    box-shadow: 0 1vmin 3vmin rgba(0,0,0,0.15);
    min-height: 26vmin;
    min-width: 26vmin;
}
.vehicle-card:active { transform: scale(0.92); }
.vehicle-card .v-emoji { font-size: 11vmin; line-height: 1.1; }
.vehicle-card .v-name { font-size: 4vmin; font-weight: 700; color: #333; margin-top: 1.5vmin; }

/* ========== æ¸¸æˆä¹å›­å…¥å£ ========== */
.park-divider {
    width: min(80vw, 80vh); height: 1px;
    background: rgba(255,255,255,0.4);
    margin: 5vmin 0 3vmin;
}
.park-title {
    font-size: 5.5vmin; font-weight: 800; color: #fff;
    text-shadow: 0 0.3vmin 0.8vmin rgba(0,0,0,0.15);
    margin-bottom: 3vmin;
}
#parkGrid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 2.5vmin;
    width: min(92vw, 90vh);
    padding: 0 2vmin;
}
.park-card {
    display: flex; align-items: center; gap: 2.5vmin;
    background: rgba(255,255,255,0.88);
    border-radius: 3.5vmin;
    padding: 2.5vmin 3vmin;
    cursor: pointer;
    transition: transform 0.15s ease;
    box-shadow: 0 0.6vmin 2vmin rgba(0,0,0,0.12);
    text-decoration: none;
    min-height: 14vmin;
}
.park-card:active { transform: scale(0.93); }
.park-card .p-emoji { font-size: 7vmin; line-height: 1; flex-shrink: 0; }
.park-card .p-name { font-size: 3.5vmin; font-weight: 700; color: #333; }

/* ========== æ¸¸æˆç•Œé¢ ========== */
#gameScreen {
    position: fixed; inset: 0;
    display: none;
}
#gameScreen.active { display: block; }

#gameCanvas {
    width: 100vw; height: 100vh; display: block;
}

/* åˆ†æ•° */
#scoreDisplay {
    position: fixed; top: 2.5vmin; left: 50%; transform: translateX(-50%);
    font-size: 7vmin; font-weight: 900; color: #FFD700;
    text-shadow: 0 0.4vmin 1vmin rgba(0,0,0,0.4);
    pointer-events: none; z-index: 20;
    display: flex; align-items: center; gap: 1.5vmin;
}

/* éŸ³ä¹æŒ‰é’® */
#musicBtn {
    position: fixed; top: 2vmin; right: 2vmin;
    width: 10vmin; height: 10vmin;
    font-size: 5.5vmin; line-height: 10vmin; text-align: center;
    background: rgba(255,255,255,0.3); border-radius: 50%;
    z-index: 20; cursor: pointer;
}

/* æš‚åœæŒ‰é’® */
#pauseBtn {
    position: fixed; top: 14vmin; right: 2vmin;
    width: 10vmin; height: 10vmin;
    font-size: 5.5vmin; line-height: 10vmin; text-align: center;
    background: rgba(255,255,255,0.3); border-radius: 50%;
    z-index: 20; cursor: pointer;
}

/* æš‚åœè’™å±‚ */
#pauseOverlay {
    position: fixed; inset: 0;
    background: rgba(0,0,0,0.5);
    display: none; align-items: center; justify-content: center;
    flex-direction: column; z-index: 30; cursor: pointer;
}
#pauseOverlay.show { display: flex; }
#pauseOverlay .pause-play { font-size: 22vmin; line-height: 1; filter: drop-shadow(0 1vmin 2vmin rgba(0,0,0,0.3)); }
#pauseOverlay .pause-hint { font-size: 5vmin; color: rgba(255,255,255,0.85); margin-top: 3vmin; }

/* è¿”å›æŒ‰é’® */
#homeBtn {
    position: fixed; top: 2vmin; left: 2vmin;
    width: 10vmin; height: 10vmin;
    font-size: 5.5vmin; line-height: 10vmin; text-align: center;
    background: rgba(255,255,255,0.3); border-radius: 50%;
    z-index: 20; cursor: pointer; opacity: 0.6;
}

/* åœºæ™¯æç¤º */
#sceneLabel {
    position: fixed; top: 45%; left: 50%; transform: translate(-50%, -50%);
    font-size: 12vmin; font-weight: 900; color: #fff;
    text-shadow: 0 0.5vmin 2vmin rgba(0,0,0,0.4);
    pointer-events: none; z-index: 20;
    opacity: 0; transition: opacity 0.4s;
}
#sceneLabel.show { opacity: 1; }

/* åº†ç¥æ–‡å­— */
#celebrateText {
    position: fixed; top: 35%; left: 50%; transform: translate(-50%, -50%);
    font-size: 14vmin; font-weight: 900; color: #FF4081;
    text-shadow: 0 0.5vmin 2vmin rgba(0,0,0,0.3);
    pointer-events: none; z-index: 25;
    opacity: 0; transition: opacity 0.3s;
}
#celebrateText.show { opacity: 1; animation: celebPop 0.5s ease; }
@keyframes celebPop {
    0% { transform: translate(-50%, -50%) scale(0.3); }
    50% { transform: translate(-50%, -50%) scale(1.15); }
    100% { transform: translate(-50%, -50%) scale(1); }
}
</style>
</head>
<body>

<!-- ========== é€‰è½¦ç•Œé¢ ========== -->
<div id="selectScreen">
    <div class="select-title">å¤§é¥¼å¼€è½¦å•¦ï¼</div>
    <div class="select-subtitle">é€‰ä¸€è¾†ä½ å–œæ¬¢çš„è½¦å§ï½</div>
    <div id="vehicleGrid"></div>

    <div class="park-divider"></div>
    <div class="park-title">ğŸ® å¤§é¥¼æ¸¸æˆä¹å›­</div>
    <div id="parkGrid">
        <a class="park-card" href="https://xutao1988.github.io/game_qiaodishu/"><div class="p-emoji">ğŸ”¨</div><div class="p-name">æ•²å¤§é¥¼å¤§ä½œæˆ˜</div></a>
        <a class="park-card" href="https://xutao1988.github.io/game_animal_name/animal-game.html"><div class="p-emoji">ğŸ¾</div><div class="p-name">è¯†åˆ«åŠ¨ç‰©è‹±æ–‡å</div></a>
        <a class="park-card" href="https://xutao1988.github.io/game_tank_battle/"><div class="p-emoji">ğŸ¯</div><div class="p-name">å¦å…‹å¤§æˆ˜</div></a>
        <a class="park-card" href="https://xutao1988.github.io/game_bubble/"><div class="p-emoji">ğŸ«§</div><div class="p-name">æ³¡æ³¡å¤§ä½œæˆ˜</div></a>
    </div>
</div>

<!-- ========== æ¸¸æˆç•Œé¢ ========== -->
<div id="gameScreen">
    <canvas id="gameCanvas"></canvas>
    <div id="scoreDisplay">â­ <span id="scoreNum">0</span></div>
    <div id="musicBtn">ğŸ”Š</div>
    <div id="pauseBtn">â¸</div>
    <div id="homeBtn">ğŸ </div>
    <div id="sceneLabel"></div>
    <div id="celebrateText"></div>
    <div id="pauseOverlay">
        <div class="pause-play">â–¶ï¸</div>
        <div class="pause-hint">ç‚¹å‡»ç»§ç»­</div>
    </div>
</div>

<script>
// ================================================================
//  å¸¸é‡
// ================================================================
const VEHICLES = [
    { id: 'car',       name: 'å°æ±½è½¦', emoji: 'ğŸš—', color: '#FF4444', bodyW: 0.16, bodyH: 0.22 },
    { id: 'train',     name: 'å°ç«è½¦', emoji: 'ğŸš‚', color: '#4488FF', bodyW: 0.14, bodyH: 0.28 },
    { id: 'tank',      name: 'å°å¦å…‹', emoji: '', color: '#44AA44', bodyW: 0.18, bodyH: 0.20,
      cardIcon: '<svg viewBox="0 0 100 110" style="width:11vmin;height:12vmin"><rect x="5" y="15" width="17" height="80" rx="7" fill="#3a6b35"/><line x1="13.5" y1="22" x2="13.5" y2="88" stroke="#2a5525" stroke-width="6" stroke-dasharray="7 5"/><rect x="78" y="15" width="17" height="80" rx="7" fill="#3a6b35"/><line x1="86.5" y1="22" x2="86.5" y2="88" stroke="#2a5525" stroke-width="6" stroke-dasharray="7 5"/><rect x="19" y="20" width="62" height="68" rx="6" fill="#5a9b55" stroke="#4a8545" stroke-width="1.5"/><circle cx="50" cy="56" r="19" fill="#6bbb65" stroke="#5aab55" stroke-width="1.5"/><rect x="43" y="2" width="14" height="46" rx="5" fill="#4a8b45" stroke="#3a7535" stroke-width="1.5"/><circle cx="50" cy="56" r="5" fill="#5aab55"/><text x="50" y="100" text-anchor="middle" font-size="10" fill="#4a8b45" font-weight="bold">TANK</text></svg>' },
    { id: 'firetruck', name: 'æ¶ˆé˜²è½¦', emoji: 'ğŸš’', color: '#FF6600', bodyW: 0.15, bodyH: 0.26 },
    { id: 'bus',       name: 'å¤§å·´å£«', emoji: 'ğŸšŒ', color: '#FFAA00', bodyW: 0.17, bodyH: 0.26 },
    { id: 'rocket',    name: 'å°ç«ç®­', emoji: 'ğŸš€', color: '#9944FF', bodyW: 0.13, bodyH: 0.26 },
];

const SCENES = [
    { name: 'åŸå¸‚',  emoji: 'ğŸ™ï¸', sky: '#87CEEB', ground: '#7EC87E', road: '#666666', line: '#FFFFFF', sides: ['ğŸ¢','ğŸ ','ğŸ¬','ğŸª','ğŸ«','ğŸ—ï¸'] },
    { name: 'ä¹¡æ‘',  emoji: 'ğŸŒ¾', sky: '#9AD8F5', ground: '#3DA53D', road: '#9E8B6E', line: '#FFFFFF', sides: ['ğŸŒ³','ğŸŒ»','ğŸ¡','ğŸŒ¾','ğŸŒ²','ğŸ„'] },
    { name: 'æµ·è¾¹',  emoji: 'ğŸ–ï¸', sky: '#38BDF8', ground: '#F4C77D', road: '#D2B48C', line: '#FFFFFF', sides: ['ğŸŒ´','ğŸš','â›µ','ğŸ¦€','ğŸ ','ğŸ–ï¸'] },
    { name: 'å¤ªç©º',  emoji: 'ğŸŒŒ', sky: '#0B0030', ground: '#15103A', road: '#3B2872', line: '#9F8FFF', sides: ['âœ¨','ğŸª','ğŸ›¸','ğŸŒ™','â˜„ï¸','ğŸ‘½'] },
];

const COLLECTIBLES = [
    { emoji: 'â­', pts: 1 },
    { emoji: 'ğŸª™', pts: 1 },
    { emoji: 'ğŸ¬', pts: 1 },
    { emoji: 'â¤ï¸', pts: 1 },
    { emoji: 'ğŸˆ', pts: 1 },
    { emoji: 'ğŸŒˆ', pts: 3 },
];

const ANIMALS = ['ğŸ¶','ğŸ±','ğŸ°','ğŸ¼','ğŸ¦Š','ğŸ¸','ğŸ¥','ğŸ·','ğŸ®','ğŸ¦'];

const GREETINGS = [
    'Hello!', 'Hi!', 'Hey!', 'å—¨!', 'ä½ å¥½!',
    'å¤§é¥¼ä½ å¥½å•Š!', 'å¤§é¥¼~', 'å“ˆå–½!', 'å˜¿å˜¿~',
    'å¤§é¥¼å¥½æ£’!', 'Hi å¤§é¥¼!', 'åŠ æ²¹å¤§é¥¼!',
    'å¤§é¥¼å†²å‘€!', 'å“‡å¤§é¥¼!', 'ä½ å¥½å‘€~',
];

const PRAISES = ['å¥½æ£’ï¼','å¤ªå‰å®³äº†ï¼','å“‡ï¼','å˜»å˜»ï¼','è€¶ï¼','çœŸæ£’ï¼','åŠ æ²¹ï¼','å¥½å‰å®³ï¼'];

// å¤§é¥¼ç…§ç‰‡ï¼ˆé¢„åŠ è½½ï¼‰
const PHOTOS = ['mole.jpg', 'å¤§é¥¼3.jpg', 'å¤§é¥¼4.jpg', 'å¤§é¥¼2.jpg', 'å¤§é¥¼5.jpg'];
const photoImages = [];
(function preloadPhotos() {
    PHOTOS.forEach((src, i) => {
        const img = new Image();
        img.src = src;
        photoImages[i] = img;
    });
})();

// ================================================================
//  éŸ³é¢‘å¼•æ“ï¼ˆWeb Audio APIï¼Œé›¶å¤–éƒ¨æ–‡ä»¶ï¼‰
// ================================================================
class AudioEngine {
    constructor() {
        this.ctx = null;
        this.bgmOn = false;
        this.bgmTimer = null;
        this.muted = false;
    }

    init() {
        if (this.ctx) return;
        this.ctx = new (window.AudioContext || window.webkitAudioContext)();
    }

    resume() {
        if (this.ctx && this.ctx.state === 'suspended') this.ctx.resume();
    }

    _note(freq, dur, start, type, vol) {
        if (!this.ctx || this.muted) return;
        const o = this.ctx.createOscillator();
        const g = this.ctx.createGain();
        o.type = type || 'sine';
        o.frequency.value = freq;
        g.gain.setValueAtTime(vol || 0.25, start);
        g.gain.exponentialRampToValueAtTime(0.001, start + dur);
        o.connect(g); g.connect(this.ctx.destination);
        o.start(start); o.stop(start + dur + 0.05);
    }

    playCollect() {
        if (!this.ctx) return;
        const t = this.ctx.currentTime;
        this._note(784, 0.1, t, 'sine', 0.3);
        this._note(1047, 0.15, t + 0.07, 'sine', 0.25);
    }

    playBonus() {
        if (!this.ctx) return;
        const t = this.ctx.currentTime;
        [523, 659, 784, 1047].forEach((f, i) => this._note(f, 0.12, t + i * 0.08, 'sine', 0.25));
    }

    playAnimalSound() {
        if (!this.ctx) return;
        const t = this.ctx.currentTime;
        const o = this.ctx.createOscillator();
        const g = this.ctx.createGain();
        o.type = 'sine';
        o.frequency.setValueAtTime(350, t);
        o.frequency.exponentialRampToValueAtTime(700, t + 0.08);
        o.frequency.exponentialRampToValueAtTime(450, t + 0.2);
        g.gain.setValueAtTime(0.25, t);
        g.gain.exponentialRampToValueAtTime(0.001, t + 0.3);
        o.connect(g); g.connect(this.ctx.destination);
        o.start(t); o.stop(t + 0.35);
    }

    playSceneChange() {
        if (!this.ctx) return;
        const t = this.ctx.currentTime;
        [392, 523, 659].forEach((f, i) => this._note(f, 0.35, t + i * 0.15, 'triangle', 0.15));
    }

    startBGM() {
        if (this.bgmOn) return;
        this.bgmOn = true;
        this._loopBGM();
    }

    _loopBGM() {
        if (!this.bgmOn || !this.ctx) return;
        // å°æ˜Ÿæ˜Ÿæ—‹å¾‹
        const melody = [
            262, 262, 392, 392, 440, 440, 392, 0,
            349, 349, 330, 330, 294, 294, 262, 0,
            392, 392, 349, 349, 330, 330, 294, 0,
            392, 392, 349, 349, 330, 330, 294, 0,
            262, 262, 392, 392, 440, 440, 392, 0,
            349, 349, 330, 330, 294, 294, 262, 0
        ];
        const nd = 0.22;
        const t = this.ctx.currentTime + 0.05;
        melody.forEach((f, i) => {
            if (f > 0) this._note(f, nd * 0.75, t + i * nd, 'sine', 0.08);
        });
        this.bgmTimer = setTimeout(() => this._loopBGM(), melody.length * nd * 1000);
    }

    stopBGM() {
        this.bgmOn = false;
        if (this.bgmTimer) { clearTimeout(this.bgmTimer); this.bgmTimer = null; }
    }

    toggleBGM() {
        if (this.bgmOn) this.stopBGM(); else this.startBGM();
        return this.bgmOn;
    }
}

// ================================================================
//  æ¸¸æˆä¸»é€»è¾‘
// ================================================================
class Game {
    constructor() {
        this.canvas = document.getElementById('gameCanvas');
        this.ctx = this.canvas.getContext('2d');
        this.audio = new AudioEngine();
        this.dpr = window.devicePixelRatio || 1;

        // é€»è¾‘å°ºå¯¸
        this.W = 0; this.H = 0;

        // çŠ¶æ€
        this.running = false;
        this.vehicle = null;
        this.score = 0;
        this.totalCollected = 0;

        // é“è·¯
        this.roadScrollY = 0;
        this.scrollSpeed = 0; // px/sï¼Œä¼šæ ¹æ®å±å¹•å¤§å°è®¾ç½®

        // è½¦è¾†ä½ç½®
        this.vx = 0; this.vy = 0;
        this.targetX = 0;
        this.touchActive = false;

        // å¯æ”¶é›†ç‰©
        this.collectibles = [];
        this.collectTimer = 0;
        this.collectInterval = 1800; // ms

        // åŠ¨ç‰©
        this.animals = [];
        this.animalTimer = 0;
        this.animalInterval = 12000; // ms

        // ç²’å­
        this.particles = [];

        // é£˜å­—
        this.popups = [];

        // åœºæ™¯
        this.sceneIndex = 0;
        this.sceneTimer = 0;
        this.sceneDuration = 28000; // ms
        this.sceneTransition = 0; // 0~1

        // ä¾§è¾¹è£…é¥°æ»šåŠ¨å…ƒç´ 
        this.sideElements = [];

        // åº†ç¥é‡Œç¨‹ç¢‘
        this.nextMilestone = 10;

        // æš‚åœ
        this.paused = false;
        this.bgmWasOn = false;

        // å¤§é¥¼ç…§ç‰‡
        this.currentPhoto = null;

        // é”®ç›˜çŠ¶æ€
        this.keysDown = { left: false, right: false };
        this.keySpeed = 0;

        // ä¸Šä¸€å¸§æ—¶é—´
        this.lastTime = 0;
        this.animFrameId = null;

        this._resize();
        window.addEventListener('resize', () => this._resize());
    }

    _resize() {
        this.W = window.innerWidth;
        this.H = window.innerHeight;
        this.canvas.width = this.W * this.dpr;
        this.canvas.height = this.H * this.dpr;
        this.canvas.style.width = this.W + 'px';
        this.canvas.style.height = this.H + 'px';
        this.ctx.setTransform(this.dpr, 0, 0, this.dpr, 0, 0);

        // æ ¹æ®å±å¹•è®¡ç®—å…³é”®å°ºå¯¸
        this.roadW = this.W * 0.52;
        this.roadL = (this.W - this.roadW) / 2;
        this.roadR = this.roadL + this.roadW;
        this.laneW = this.roadW / 3;
        this.scrollSpeed = this.H * 0.28; // æ¯ç§’æ»šè¿‡å±å¹•é«˜åº¦çš„ 28%
        this.keySpeed = this.W * 0.45;  // é”®ç›˜ç§»åŠ¨é€Ÿåº¦

        if (this.vehicle) {
            this.vy = this.H * 0.76;
            this.vx = Math.max(this.roadL + this.laneW * 0.5, Math.min(this.vx, this.roadR - this.laneW * 0.5));
            this.targetX = this.vx;
        }
    }

    // -------- åˆå§‹åŒ–ä¾§è¾¹è£…é¥° --------
    _initSideElements() {
        this.sideElements = [];
        const scene = SCENES[this.sceneIndex];
        const spacing = this.H * 0.22;
        const count = Math.ceil(this.H / spacing) + 3;
        for (let i = 0; i < count; i++) {
            // å·¦ä¾§
            this.sideElements.push({
                x: this.roadL * 0.35 + Math.random() * this.roadL * 0.35,
                y: i * spacing - spacing,
                emoji: scene.sides[Math.floor(Math.random() * scene.sides.length)],
                side: 'left'
            });
            // å³ä¾§
            this.sideElements.push({
                x: this.roadR + (this.W - this.roadR) * 0.2 + Math.random() * (this.W - this.roadR) * 0.45,
                y: i * spacing - spacing + spacing * 0.5,
                emoji: scene.sides[Math.floor(Math.random() * scene.sides.length)],
                side: 'right'
            });
        }
    }

    // -------- å¼€å§‹æ¸¸æˆ --------
    start(vehicleData) {
        this.vehicle = vehicleData;
        this.score = 0;
        this.totalCollected = 0;
        this.collectibles = [];
        this.animals = [];
        this.particles = [];
        this.popups = [];
        this.sceneIndex = 0;
        this.sceneTimer = 0;
        this.sceneTransition = 0;
        this.collectTimer = 0;
        this.animalTimer = 0;
        this.nextMilestone = 10;
        this.roadScrollY = 0;

        this.vx = this.W / 2;
        this.vy = this.H * 0.76;
        this.targetX = this.vx;
        this.touchActive = false;
        this.keysDown = { left: false, right: false };
        this.paused = false;
        document.getElementById('pauseOverlay').classList.remove('show');
        document.getElementById('pauseBtn').textContent = 'â¸';

        // éšæœºé€‰ä¸€å¼ å¤§é¥¼ç…§ç‰‡
        this.currentPhoto = photoImages[Math.floor(Math.random() * photoImages.length)];

        this.collectTimer = this.collectInterval - 600; // å¿«é€Ÿå‡ºç°ç¬¬ä¸€ä¸ªæ”¶é›†ç‰©

        this._initSideElements();
        this._updateScoreDisplay();

        document.getElementById('selectScreen').classList.add('hidden');
        document.getElementById('gameScreen').classList.add('active');

        this.audio.init();
        this.audio.resume();
        this.audio.startBGM();
        document.getElementById('musicBtn').textContent = 'ğŸ”Š';

        // å–æ¶ˆæ—§çš„åŠ¨ç”»å¾ªç¯ï¼ˆé˜²æ­¢é‡å¤å¯åŠ¨ï¼‰
        if (this.animFrameId) cancelAnimationFrame(this.animFrameId);

        this.running = true;
        this.lastTime = performance.now();
        this._render(); // ç«‹å³ç»˜åˆ¶ç¬¬ä¸€å¸§
        this.animFrameId = requestAnimationFrame((t) => this._loop(t));

        // ä¿å­˜ä¸Šæ¬¡é€‰æ‹©
        try { localStorage.setItem('dabing_travel_lastVehicle', vehicleData.id); } catch(e) {}
    }

    stop() {
        this.running = false;
        if (this.animFrameId) { cancelAnimationFrame(this.animFrameId); this.animFrameId = null; }
        this.audio.stopBGM();
        document.getElementById('gameScreen').classList.remove('active');
        document.getElementById('selectScreen').classList.remove('hidden');
        // ä¿å­˜æœ€é«˜åˆ†
        try {
            const prev = parseInt(localStorage.getItem('dabing_travel_highscore') || '0');
            if (this.score > prev) localStorage.setItem('dabing_travel_highscore', String(this.score));
        } catch(e) {}
    }

    // -------- æš‚åœ/ç»§ç»­ --------
    togglePause() {
        if (!this.running) return;
        this.paused = !this.paused;
        const overlay = document.getElementById('pauseOverlay');
        const btn = document.getElementById('pauseBtn');
        if (this.paused) {
            overlay.classList.add('show');
            btn.textContent = 'â–¶';
            this.bgmWasOn = this.audio.bgmOn;
            this.audio.stopBGM();
        } else {
            overlay.classList.remove('show');
            btn.textContent = 'â¸';
            this.lastTime = performance.now(); // é˜²æ­¢æ¢å¤æ—¶ dt è·³å˜
            if (this.bgmWasOn) this.audio.startBGM();
        }
    }

    // -------- ä¸»å¾ªç¯ --------
    _loop(now) {
        if (!this.running) return;
        const dt = Math.min((now - this.lastTime) / 1000, 0.05); // ä¸Šé™ 50ms
        this.lastTime = now;

        if (!this.paused) {
            this._update(dt);
        }
        this._render();

        this.animFrameId = requestAnimationFrame((t) => this._loop(t));
    }

    // -------- æ›´æ–° --------
    _update(dt) {
        const dtMs = dt * 1000;

        // é“è·¯æ»šåŠ¨
        this.roadScrollY += this.scrollSpeed * dt;

        // è½¦è¾†è·Ÿéšè§¦æ‘¸
        if (this.touchActive) {
            this.vx += (this.targetX - this.vx) * Math.min(dt * 10, 1);
        }
        // é”®ç›˜å·¦å³é”®æ§åˆ¶
        if (this.keysDown.left)  this.vx -= this.keySpeed * dt;
        if (this.keysDown.right) this.vx += this.keySpeed * dt;
        // é™åˆ¶èŒƒå›´
        const halfVW = this.vehicle.bodyW * this.W * 0.5;
        this.vx = Math.max(this.roadL + halfVW, Math.min(this.vx, this.roadR - halfVW));

        // ä¾§è¾¹è£…é¥°æ»šåŠ¨
        const spacing = this.H * 0.22;
        const scene = SCENES[this.sceneIndex];
        for (const el of this.sideElements) {
            el.y += this.scrollSpeed * dt;
            if (el.y > this.H + 60) {
                el.y -= (Math.ceil(this.H / spacing) + 3) * spacing;
                el.emoji = scene.sides[Math.floor(Math.random() * scene.sides.length)];
                if (el.side === 'left') {
                    el.x = this.roadL * 0.2 + Math.random() * this.roadL * 0.5;
                } else {
                    el.x = this.roadR + (this.W - this.roadR) * 0.15 + Math.random() * (this.W - this.roadR) * 0.5;
                }
            }
        }

        // ç”Ÿæˆæ”¶é›†ç‰©
        this.collectTimer += dtMs;
        if (this.collectTimer >= this.collectInterval && this.collectibles.length < 4) {
            this.collectTimer = 0;
            this.collectInterval = 1500 + Math.random() * 1200;
            this._spawnCollectible();
        }

        // æ›´æ–°æ”¶é›†ç‰©
        for (let i = this.collectibles.length - 1; i >= 0; i--) {
            const c = this.collectibles[i];
            c.y += this.scrollSpeed * dt;
            c.age += dtMs;
            // ç¢°æ’æ£€æµ‹
            const dx = c.x - this.vx;
            const dy = c.y - this.vy;
            const dist = Math.sqrt(dx * dx + dy * dy);
            const hitR = this.W * 0.08;
            if (dist < hitR) {
                this._collectItem(c);
                this.collectibles.splice(i, 1);
                continue;
            }
            // ç¦»å¼€å±å¹•
            if (c.y > this.H + 80) {
                this.collectibles.splice(i, 1);
            }
        }

        // ç”ŸæˆåŠ¨ç‰©
        this.animalTimer += dtMs;
        if (this.animalTimer >= this.animalInterval && this.animals.length < 2) {
            this.animalTimer = 0;
            this.animalInterval = 10000 + Math.random() * 10000;
            this._spawnAnimal();
        }

        // æ›´æ–°åŠ¨ç‰©
        for (let i = this.animals.length - 1; i >= 0; i--) {
            const a = this.animals[i];
            a.y += this.scrollSpeed * dt * 0.6;
            a.age += dtMs;
            a.wave = Math.sin(a.age / 300) * 10;
            // è¯­è¨€æ³¡æ³¡é€æ˜åº¦åŠ¨ç”»
            const bubbleAge = a.age - a.bubbleDelay;
            if (bubbleAge < 0) {
                a.bubbleAlpha = 0;
            } else if (bubbleAge < 250) {
                a.bubbleAlpha = bubbleAge / 250; // æ·¡å…¥
            } else if (bubbleAge < a.bubbleDuration - 400) {
                a.bubbleAlpha = 1; // å®Œå…¨æ˜¾ç¤º
            } else if (bubbleAge < a.bubbleDuration) {
                a.bubbleAlpha = (a.bubbleDuration - bubbleAge) / 400; // æ·¡å‡º
            } else {
                a.bubbleAlpha = 0;
            }
            if (a.y > this.H + 100) {
                this.animals.splice(i, 1);
            }
        }

        // æ›´æ–°ç²’å­
        for (let i = this.particles.length - 1; i >= 0; i--) {
            const p = this.particles[i];
            p.x += p.vx * dt;
            p.y += p.vy * dt;
            p.life -= dt;
            if (p.life <= 0) this.particles.splice(i, 1);
        }

        // æ›´æ–°é£˜å­—
        for (let i = this.popups.length - 1; i >= 0; i--) {
            const pp = this.popups[i];
            pp.y -= 80 * dt;
            pp.life -= dt;
            if (pp.life <= 0) this.popups.splice(i, 1);
        }

        // åœºæ™¯åˆ‡æ¢
        this.sceneTimer += dtMs;
        if (this.sceneTimer >= this.sceneDuration) {
            this.sceneTimer = 0;
            const oldIndex = this.sceneIndex;
            this.sceneIndex = (this.sceneIndex + 1) % SCENES.length;
            this._initSideElements();
            this.audio.playSceneChange();
            this._showSceneLabel(SCENES[this.sceneIndex]);
        }
    }

    // -------- ç”Ÿæˆæ”¶é›†ç‰© --------
    _spawnCollectible() {
        const lane = Math.floor(Math.random() * 3);
        const cx = this.roadL + this.laneW * (lane + 0.5);
        const type = COLLECTIBLES[Math.floor(Math.random() * COLLECTIBLES.length)];
        this.collectibles.push({
            x: cx + (Math.random() - 0.5) * this.laneW * 0.3,
            y: -50,
            type: type,
            age: 0,
            bobPhase: Math.random() * Math.PI * 2,
        });
    }

    // -------- æ”¶é›†é“å…· --------
    _collectItem(c) {
        this.score += c.type.pts;
        this.totalCollected++;
        this._updateScoreDisplay();
        this.audio.playCollect();

        // ç²’å­ç‰¹æ•ˆ
        const colors = ['#FFD700', '#FF69B4', '#00BFFF', '#7FFF00', '#FF6347', '#DA70D6'];
        for (let i = 0; i < 10; i++) {
            const angle = (Math.PI * 2 / 10) * i;
            const speed = 120 + Math.random() * 100;
            this.particles.push({
                x: c.x, y: c.y,
                vx: Math.cos(angle) * speed,
                vy: Math.sin(angle) * speed,
                life: 0.6 + Math.random() * 0.3,
                maxLife: 0.9,
                color: colors[Math.floor(Math.random() * colors.length)],
                size: 3 + Math.random() * 4,
            });
        }

        // é£˜å­—
        this.popups.push({ x: c.x, y: c.y, text: '+' + c.type.pts, life: 0.8, maxLife: 0.8 });

        // å½©è™¹é¢å¤–åº†ç¥
        if (c.type.pts > 1) {
            this.audio.playBonus();
            this.popups.push({ x: c.x, y: c.y - 30, text: 'ğŸŒˆ', life: 1.0, maxLife: 1.0 });
        }

        // é‡Œç¨‹ç¢‘åº†ç¥
        if (this.totalCollected >= this.nextMilestone) {
            this.nextMilestone += 10;
            this._showCelebration();
        }
    }

    // -------- ç”ŸæˆåŠ¨ç‰© --------
    _spawnAnimal() {
        const side = Math.random() < 0.5 ? 'left' : 'right';
        const x = side === 'left'
            ? this.roadL * 0.4
            : this.roadR + (this.W - this.roadR) * 0.6;
        this.animals.push({
            x: x,
            y: -60,
            emoji: ANIMALS[Math.floor(Math.random() * ANIMALS.length)],
            side: side,
            age: 0,
            wave: 0,
            // è¯­è¨€æ³¡æ³¡
            greeting: GREETINGS[Math.floor(Math.random() * GREETINGS.length)],
            bubbleDelay: 400 + Math.random() * 400,  // å‡ºç°åå»¶è¿Ÿå¼¹å‡º
            bubbleDuration: 3500,                      // æ³¡æ³¡æŒç»­æ—¶é—´
            bubbleAlpha: 0,                            // å½“å‰é€æ˜åº¦
        });
        this.audio.playAnimalSound();
    }

    // -------- æ¸²æŸ“ --------
    _render() {
        const ctx = this.ctx;
        const W = this.W, H = this.H;
        const scene = SCENES[this.sceneIndex];

        // èƒŒæ™¯å¤©ç©º
        ctx.fillStyle = scene.sky;
        ctx.fillRect(0, 0, W, H);

        // ä¸¤ä¾§åœ°é¢
        ctx.fillStyle = scene.ground;
        ctx.fillRect(0, 0, this.roadL, H);
        ctx.fillRect(this.roadR, 0, W - this.roadR, H);

        // ä¾§è¾¹è£…é¥°
        ctx.font = (W * 0.07) + 'px serif';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        for (const el of this.sideElements) {
            ctx.fillText(el.emoji, el.x, el.y);
        }

        // é“è·¯
        ctx.fillStyle = scene.road;
        ctx.fillRect(this.roadL, 0, this.roadW, H);

        // é“è·¯è¾¹çº¿
        ctx.strokeStyle = scene.line;
        ctx.lineWidth = W * 0.008;
        ctx.beginPath();
        ctx.moveTo(this.roadL, 0); ctx.lineTo(this.roadL, H);
        ctx.moveTo(this.roadR, 0); ctx.lineTo(this.roadR, H);
        ctx.stroke();

        // è½¦é“çº¿ï¼ˆè™šçº¿æ»šåŠ¨ï¼‰
        const dashLen = H * 0.06;
        const gapLen = H * 0.05;
        const totalDash = dashLen + gapLen;
        const offset = this.roadScrollY % totalDash;
        ctx.strokeStyle = scene.line;
        ctx.lineWidth = W * 0.005;
        ctx.setLineDash([dashLen, gapLen]);
        for (let lane = 1; lane < 3; lane++) {
            const lx = this.roadL + this.laneW * lane;
            ctx.beginPath();
            ctx.moveTo(lx, -totalDash + offset);
            ctx.lineTo(lx, H + totalDash);
            ctx.stroke();
        }
        ctx.setLineDash([]);

        // åŠ¨ç‰© + è¯­è¨€æ³¡æ³¡
        const animalSize = W * 0.1;
        for (const a of this.animals) {
            // åŠ¨ç‰©æœ¬ä½“
            ctx.font = animalSize + 'px serif';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.save();
            ctx.translate(a.x, a.y);
            ctx.rotate(a.wave * Math.PI / 180);
            ctx.fillText(a.emoji, 0, 0);
            ctx.restore();

            // è¯­è¨€æ³¡æ³¡
            if (a.bubbleAlpha > 0.01) {
                ctx.save();
                ctx.globalAlpha = a.bubbleAlpha;

                // æµ‹é‡æ–‡å­—å®½åº¦
                const bFontSize = Math.max(12, W * 0.035);
                ctx.font = 'bold ' + bFontSize + 'px "PingFang SC","Heiti SC",sans-serif';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                const textW = ctx.measureText(a.greeting).width;
                const padX = bFontSize * 0.6;
                const padY = bFontSize * 0.45;
                const bw = textW + padX * 2;
                const bh = bFontSize + padY * 2;
                const br = bh * 0.35; // åœ†è§’

                // æ³¡æ³¡ä½ç½®ï¼šåŠ¨ç‰©ä¸Šæ–¹ï¼Œåå‘é“è·¯æ–¹å‘
                const bubbleX = a.x + (a.side === 'left' ? animalSize * 0.5 : -animalSize * 0.5);
                const bubbleY = a.y - animalSize * 0.65;
                // å°å°¾å·´æŒ‡å‘æ–¹å‘
                const tailDir = a.side === 'left' ? -1 : 1;

                // æ³¡æ³¡å¼¹è·³åŠ¨ç”»
                const bounce = a.bubbleAlpha < 1 ? (1 - a.bubbleAlpha) * 3 : 0;
                const by = bubbleY - bounce;

                // æ³¡æ³¡é˜´å½±
                ctx.fillStyle = 'rgba(0,0,0,0.1)';
                this._roundRect(ctx, bubbleX - bw/2 + 2, by - bh/2 + 2, bw, bh, br);
                ctx.fill();

                // æ³¡æ³¡ç™½è‰²èƒŒæ™¯
                ctx.fillStyle = '#FFFFFF';
                this._roundRect(ctx, bubbleX - bw/2, by - bh/2, bw, bh, br);
                ctx.fill();
                ctx.strokeStyle = 'rgba(0,0,0,0.12)';
                ctx.lineWidth = 1;
                ctx.stroke();

                // å°ä¸‰è§’å°¾å·´ï¼ˆæŒ‡å‘åŠ¨ç‰©ï¼‰
                ctx.fillStyle = '#FFFFFF';
                ctx.beginPath();
                const tx = bubbleX + tailDir * bw * 0.15;
                ctx.moveTo(tx - 6, by + bh/2 - 1);
                ctx.lineTo(tx + tailDir * 2, by + bh/2 + bFontSize * 0.5);
                ctx.lineTo(tx + 6, by + bh/2 - 1);
                ctx.closePath();
                ctx.fill();

                // æ–‡å­—
                ctx.fillStyle = '#333';
                ctx.fillText(a.greeting, bubbleX, by);

                ctx.restore();
            }
        }

        // æ”¶é›†ç‰©
        const cSize = W * 0.09;
        ctx.font = cSize + 'px serif';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        for (const c of this.collectibles) {
            const bob = Math.sin(c.bobPhase + c.age / 250) * 5;
            const scale = 1 + Math.sin(c.age / 400) * 0.08;
            ctx.save();
            ctx.translate(c.x, c.y + bob);
            ctx.scale(scale, scale);
            ctx.fillText(c.type.emoji, 0, 0);
            ctx.restore();
        }

        // è½¦è¾†
        this._drawVehicle(ctx);

        // ç²’å­
        for (const p of this.particles) {
            const alpha = Math.max(0, p.life / p.maxLife);
            ctx.globalAlpha = alpha;
            ctx.fillStyle = p.color;
            ctx.beginPath();
            ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
            ctx.fill();
        }
        ctx.globalAlpha = 1;

        // é£˜å­—
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        for (const pp of this.popups) {
            const alpha = Math.max(0, pp.life / pp.maxLife);
            ctx.globalAlpha = alpha;
            ctx.font = 'bold ' + (W * 0.07) + 'px sans-serif';
            ctx.fillStyle = '#FFD700';
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 2;
            ctx.strokeText(pp.text, pp.x, pp.y);
            ctx.fillText(pp.text, pp.x, pp.y);
        }
        ctx.globalAlpha = 1;
    }

    // -------- ç»˜åˆ¶è½¦è¾† + å¤§é¥¼ --------
    _drawVehicle(ctx) {
        const v = this.vehicle;
        const vw = this.W * v.bodyW;
        const vh = this.W * v.bodyH;
        const cx = this.vx;
        const cy = this.vy;

        ctx.save();
        ctx.translate(cx, cy);

        // è½¦èº«ï¼ˆå°æ±½è½¦å•ç‹¬ç»˜åˆ¶æ›´ç²¾ç»†çš„é€ å‹ï¼‰
        if (v.id !== 'car') {
            ctx.fillStyle = 'rgba(0,0,0,0.15)';
            this._roundRect(ctx, -vw/2 + 4, -vh/2 + 6, vw, vh, vw * 0.2);
            ctx.fill();
            ctx.fillStyle = v.color;
            this._roundRect(ctx, -vw/2, -vh/2, vw, vh, vw * 0.2);
            ctx.fill();
        }

        // æ ¹æ®ç±»å‹ç»˜åˆ¶ç»†èŠ‚
        switch(v.id) {
            case 'car': {
                // ======== å†™å®é£æ ¼è½¿è½¦ä¿¯è§†å›¾ ========
                // è½¦åº•é˜´å½±
                ctx.fillStyle = 'rgba(0,0,0,0.13)';
                ctx.beginPath();
                ctx.ellipse(3, 5, vw*0.48, vh*0.46, 0, 0, Math.PI*2);
                ctx.fill();

                // è½®å­ï¼ˆå…ˆç”»ï¼Œåœ¨è½¦èº«ä¸‹æ–¹éœ²å‡ºï¼‰
                [[-1,-1],[1,-1],[-1,1],[1,1]].forEach(([sx,sy]) => {
                    const wx = sx * vw * 0.46;
                    const wy = sy * vh * 0.3;
                    ctx.fillStyle = '#1a1a1a';
                    ctx.beginPath();
                    ctx.ellipse(wx, wy, vw*0.1, vh*0.07, 0, 0, Math.PI*2);
                    ctx.fill();
                    ctx.fillStyle = '#777';
                    ctx.beginPath();
                    ctx.ellipse(wx, wy, vw*0.06, vh*0.042, 0, 0, Math.PI*2);
                    ctx.fill();
                    ctx.fillStyle = '#999';
                    ctx.beginPath();
                    ctx.arc(wx, wy, vw*0.02, 0, Math.PI*2);
                    ctx.fill();
                });

                // è½¦èº«è½®å»“ï¼ˆå‰çª„åå®½çš„æµçº¿å‹ï¼‰
                ctx.fillStyle = v.color;
                ctx.beginPath();
                ctx.moveTo(-vw*0.3, -vh*0.44);
                ctx.quadraticCurveTo(0, -vh*0.49, vw*0.3, -vh*0.44);
                ctx.lineTo(vw*0.42, -vh*0.15);
                ctx.lineTo(vw*0.44, vh*0.28);
                ctx.quadraticCurveTo(vw*0.42, vh*0.44, 0, vh*0.46);
                ctx.quadraticCurveTo(-vw*0.42, vh*0.44, -vw*0.44, vh*0.28);
                ctx.lineTo(-vw*0.42, -vh*0.15);
                ctx.closePath();
                ctx.fill();

                // é‡‘å±å…‰æ³½
                const carGrad = ctx.createLinearGradient(-vw*0.44, 0, vw*0.44, 0);
                carGrad.addColorStop(0, 'rgba(0,0,0,0.1)');
                carGrad.addColorStop(0.3, 'rgba(255,255,255,0.18)');
                carGrad.addColorStop(0.5, 'rgba(255,255,255,0.22)');
                carGrad.addColorStop(0.7, 'rgba(255,255,255,0.18)');
                carGrad.addColorStop(1, 'rgba(0,0,0,0.1)');
                ctx.fillStyle = carGrad;
                ctx.fill();

                // è½¦èº«è¾¹ç¼˜é«˜å…‰çº¿
                ctx.strokeStyle = 'rgba(255,255,255,0.2)';
                ctx.lineWidth = 1;
                ctx.stroke();

                // å¼•æ“ç›–ä¸­çº¿
                ctx.strokeStyle = 'rgba(0,0,0,0.1)';
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.moveTo(0, -vh*0.46);
                ctx.lineTo(0, -vh*0.22);
                ctx.stroke();

                // å‰æŒ¡é£ç»ç’ƒ
                ctx.fillStyle = 'rgba(120,200,255,0.8)';
                ctx.beginPath();
                ctx.moveTo(-vw*0.32, -vh*0.18);
                ctx.lineTo(-vw*0.25, -vh*0.36);
                ctx.quadraticCurveTo(0, -vh*0.4, vw*0.25, -vh*0.36);
                ctx.lineTo(vw*0.32, -vh*0.18);
                ctx.closePath();
                ctx.fill();
                // ç»ç’ƒåå…‰
                ctx.strokeStyle = 'rgba(255,255,255,0.5)';
                ctx.lineWidth = 1.5;
                ctx.beginPath();
                ctx.moveTo(-vw*0.1, -vh*0.33);
                ctx.quadraticCurveTo(vw*0.02, -vh*0.35, vw*0.14, -vh*0.31);
                ctx.stroke();

                // åæŒ¡é£ç»ç’ƒ
                ctx.fillStyle = 'rgba(120,200,255,0.65)';
                ctx.beginPath();
                ctx.moveTo(-vw*0.32, vh*0.1);
                ctx.lineTo(-vw*0.35, vh*0.26);
                ctx.quadraticCurveTo(0, vh*0.33, vw*0.35, vh*0.26);
                ctx.lineTo(vw*0.32, vh*0.1);
                ctx.closePath();
                ctx.fill();

                // è½¦é¡¶é«˜å…‰
                ctx.fillStyle = 'rgba(255,255,255,0.1)';
                this._roundRect(ctx, -vw*0.25, -vh*0.16, vw*0.5, vh*0.25, vw*0.1);
                ctx.fill();

                // å‰å¤§ç¯
                ctx.fillStyle = '#FFF8CC';
                ctx.shadowColor = '#FFE066';
                ctx.shadowBlur = 5;
                [-1, 1].forEach(sx => {
                    ctx.beginPath();
                    ctx.ellipse(sx * vw*0.22, -vh*0.43, vw*0.06, vh*0.022, 0, 0, Math.PI*2);
                    ctx.fill();
                });
                ctx.shadowBlur = 0;

                // å°¾ç¯
                ctx.fillStyle = '#FF2233';
                ctx.shadowColor = '#FF0000';
                ctx.shadowBlur = 4;
                [-1, 1].forEach(sx => {
                    ctx.beginPath();
                    ctx.ellipse(sx * vw*0.3, vh*0.4, vw*0.06, vh*0.02, 0, 0, Math.PI*2);
                    ctx.fill();
                });
                ctx.shadowBlur = 0;

                // åè§†é•œ
                ctx.fillStyle = '#444';
                ctx.beginPath();
                ctx.ellipse(-vw*0.48, -vh*0.14, vw*0.04, vh*0.018, 0.3, 0, Math.PI*2);
                ctx.fill();
                ctx.beginPath();
                ctx.ellipse(vw*0.48, -vh*0.14, vw*0.04, vh*0.018, -0.3, 0, Math.PI*2);
                ctx.fill();

                break;
            }
            case 'train':
                // çƒŸå›±
                ctx.fillStyle = '#333';
                this._roundRect(ctx, -vw*0.15, -vh*0.52, vw*0.3, vh*0.1, vw*0.05);
                ctx.fill();
                // çª—æˆ·
                ctx.fillStyle = '#AAD8FF';
                this._roundRect(ctx, -vw*0.3, -vh*0.25, vw*0.6, vh*0.18, vw*0.05);
                ctx.fill();
                // è½¦è½®ï¼ˆä¸¤æ’ï¼‰
                ctx.fillStyle = '#333';
                [-1,1].forEach(sx => {
                    for (let r = -1; r <= 1; r += 0.7) {
                        ctx.beginPath();
                        ctx.arc(sx * vw * 0.45, r * vh * 0.25, vw * 0.07, 0, Math.PI*2);
                        ctx.fill();
                    }
                });
                break;
            case 'tank':
                // å±¥å¸¦
                ctx.fillStyle = '#2A7A2A';
                this._roundRect(ctx, -vw*0.52, -vh*0.42, vw*0.22, vh*0.84, vw*0.08);
                ctx.fill();
                this._roundRect(ctx, vw*0.3, -vh*0.42, vw*0.22, vh*0.84, vw*0.08);
                ctx.fill();
                // ç‚®å¡”
                ctx.fillStyle = '#3B8B3B';
                ctx.beginPath();
                ctx.arc(0, vh*0.05, vw*0.28, 0, Math.PI*2);
                ctx.fill();
                // ç‚®ç®¡
                ctx.fillStyle = '#2A6A2A';
                this._roundRect(ctx, -vw*0.06, -vh*0.55, vw*0.12, vh*0.45, vw*0.04);
                ctx.fill();
                break;
            case 'firetruck':
                // çª—æˆ·
                ctx.fillStyle = '#AAD8FF';
                this._roundRect(ctx, -vw*0.32, -vh*0.38, vw*0.64, vh*0.18, vw*0.06);
                ctx.fill();
                // äº‘æ¢¯
                ctx.strokeStyle = '#CCC';
                ctx.lineWidth = vw * 0.04;
                ctx.beginPath();
                ctx.moveTo(0, -vh*0.1);
                ctx.lineTo(0, vh*0.35);
                ctx.stroke();
                // è­¦ç¯
                ctx.fillStyle = '#FF0000';
                ctx.beginPath();
                ctx.arc(-vw*0.15, -vh*0.44, vw*0.06, 0, Math.PI*2);
                ctx.fill();
                ctx.fillStyle = '#0088FF';
                ctx.beginPath();
                ctx.arc(vw*0.15, -vh*0.44, vw*0.06, 0, Math.PI*2);
                ctx.fill();
                // è½®å­
                ctx.fillStyle = '#333';
                [[-1,-1],[1,-1],[-1,1],[1,1]].forEach(([sx,sy]) => {
                    ctx.beginPath();
                    ctx.ellipse(sx * vw * 0.46, sy * vh * 0.36, vw*0.07, vh*0.06, 0, 0, Math.PI*2);
                    ctx.fill();
                });
                break;
            case 'bus':
                // çª—æˆ·ï¼ˆä¸€æ’ï¼‰
                ctx.fillStyle = '#AAD8FF';
                for (let i = -1; i <= 1; i++) {
                    this._roundRect(ctx, -vw*0.32, -vh*0.05 + i * vh*0.22, vw*0.64, vh*0.15, vw*0.04);
                    ctx.fill();
                }
                // è½®å­
                ctx.fillStyle = '#333';
                [[-1,-1],[1,-1],[-1,1],[1,1]].forEach(([sx,sy]) => {
                    ctx.beginPath();
                    ctx.ellipse(sx * vw * 0.47, sy * vh * 0.38, vw*0.07, vh*0.06, 0, 0, Math.PI*2);
                    ctx.fill();
                });
                break;
            case 'rocket':
                // å°–å¤´
                ctx.fillStyle = '#FF4444';
                ctx.beginPath();
                ctx.moveTo(0, -vh*0.55);
                ctx.lineTo(-vw*0.35, -vh*0.25);
                ctx.lineTo(vw*0.35, -vh*0.25);
                ctx.closePath();
                ctx.fill();
                // å°¾ç¿¼
                ctx.fillStyle = '#FF6644';
                ctx.beginPath();
                ctx.moveTo(-vw*0.35, vh*0.35);
                ctx.lineTo(-vw*0.55, vh*0.52);
                ctx.lineTo(-vw*0.2, vh*0.35);
                ctx.closePath();
                ctx.fill();
                ctx.beginPath();
                ctx.moveTo(vw*0.35, vh*0.35);
                ctx.lineTo(vw*0.55, vh*0.52);
                ctx.lineTo(vw*0.2, vh*0.35);
                ctx.closePath();
                ctx.fill();
                // èˆ·çª—
                ctx.fillStyle = '#AAD8FF';
                ctx.beginPath();
                ctx.arc(0, -vh*0.05, vw*0.15, 0, Math.PI*2);
                ctx.fill();
                // ç«ç„°
                const flicker = Math.random() * 8;
                ctx.fillStyle = '#FFAA00';
                ctx.beginPath();
                ctx.moveTo(-vw*0.2, vh*0.45);
                ctx.lineTo(0, vh*0.65 + flicker);
                ctx.lineTo(vw*0.2, vh*0.45);
                ctx.closePath();
                ctx.fill();
                ctx.fillStyle = '#FF4400';
                ctx.beginPath();
                ctx.moveTo(-vw*0.12, vh*0.45);
                ctx.lineTo(0, vh*0.55 + flicker * 0.5);
                ctx.lineTo(vw*0.12, vh*0.45);
                ctx.closePath();
                ctx.fill();
                break;
        }

        // å¤§é¥¼çš„ç…§ç‰‡ï¼ˆåœ†å½¢å¤´åƒï¼‰
        const faceR = vw * 0.25;
        const faceY = v.id === 'rocket' ? -vh * 0.05 : -vh * 0.08;
        const photo = this.currentPhoto;

        if (photo && photo.complete && photo.naturalWidth > 0) {
            // åœ†å½¢è£å‰ªç»˜åˆ¶çœŸå®ç…§ç‰‡
            ctx.save();
            ctx.beginPath();
            ctx.arc(0, faceY, faceR, 0, Math.PI * 2);
            ctx.closePath();
            ctx.clip();
            // å±…ä¸­åä¸Šè£å‰ªï¼ˆäººè„¸é€šå¸¸åœ¨ç…§ç‰‡ä¸ŠåŠéƒ¨åˆ†ï¼‰
            const iw = photo.naturalWidth, ih = photo.naturalHeight;
            const minDim = Math.min(iw, ih);
            const sx = (iw - minDim) / 2;
            const sy = (ih - minDim) * 0.15; // åä¸Šå–è„¸éƒ¨
            ctx.drawImage(photo, sx, sy, minDim, minDim,
                -faceR, faceY - faceR, faceR * 2, faceR * 2);
            ctx.restore();
            // ç™½è‰²åœ†å½¢è¾¹æ¡†
            ctx.strokeStyle = '#FFF';
            ctx.lineWidth = Math.max(2, vw * 0.03);
            ctx.beginPath();
            ctx.arc(0, faceY, faceR, 0, Math.PI * 2);
            ctx.stroke();
        } else {
            // ç…§ç‰‡æœªåŠ è½½æ—¶çš„å¡é€šè„¸é™çº§
            ctx.fillStyle = '#FFDDAA';
            ctx.beginPath();
            ctx.arc(0, faceY, faceR, 0, Math.PI * 2);
            ctx.fill();
            ctx.strokeStyle = '#FFF';
            ctx.lineWidth = 2;
            ctx.stroke();
            const eyeY = faceY - faceR * 0.15;
            const eyeGap = faceR * 0.35;
            ctx.fillStyle = '#333';
            ctx.beginPath();
            ctx.arc(-eyeGap, eyeY, faceR * 0.12, 0, Math.PI * 2);
            ctx.arc(eyeGap, eyeY, faceR * 0.12, 0, Math.PI * 2);
            ctx.fill();
            ctx.strokeStyle = '#C07050';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.arc(0, faceY + faceR * 0.12, faceR * 0.28, 0.15 * Math.PI, 0.85 * Math.PI);
            ctx.stroke();
        }

        ctx.restore();
    }

    // -------- è¾…åŠ©ï¼šåœ†è§’çŸ©å½¢ --------
    _roundRect(ctx, x, y, w, h, r) {
        r = Math.min(r, w / 2, h / 2);
        ctx.beginPath();
        ctx.moveTo(x + r, y);
        ctx.lineTo(x + w - r, y);
        ctx.quadraticCurveTo(x + w, y, x + w, y + r);
        ctx.lineTo(x + w, y + h - r);
        ctx.quadraticCurveTo(x + w, y + h, x + w - r, y + h);
        ctx.lineTo(x + r, y + h);
        ctx.quadraticCurveTo(x, y + h, x, y + h - r);
        ctx.lineTo(x, y + r);
        ctx.quadraticCurveTo(x, y, x + r, y);
        ctx.closePath();
    }

    // -------- UI æ›´æ–° --------
    _updateScoreDisplay() {
        document.getElementById('scoreNum').textContent = this.score;
    }

    _showSceneLabel(scene) {
        const el = document.getElementById('sceneLabel');
        el.textContent = scene.emoji + ' ' + scene.name;
        el.classList.add('show');
        setTimeout(() => el.classList.remove('show'), 1800);
    }

    _showCelebration() {
        this.audio.playBonus();
        const el = document.getElementById('celebrateText');
        el.textContent = PRAISES[Math.floor(Math.random() * PRAISES.length)];
        el.classList.add('show');
        setTimeout(() => el.classList.remove('show'), 1500);
        // å¤§é‡å½©è‰²ç²’å­
        const colors = ['#FFD700','#FF69B4','#00BFFF','#7FFF00','#FF6347','#DA70D6','#FFB700','#00FF88'];
        for (let i = 0; i < 30; i++) {
            const angle = Math.random() * Math.PI * 2;
            const speed = 150 + Math.random() * 200;
            this.particles.push({
                x: this.W / 2 + (Math.random() - 0.5) * this.W * 0.5,
                y: this.H * 0.4,
                vx: Math.cos(angle) * speed,
                vy: Math.sin(angle) * speed - 100,
                life: 1.0 + Math.random() * 0.5,
                maxLife: 1.5,
                color: colors[Math.floor(Math.random() * colors.length)],
                size: 4 + Math.random() * 5,
            });
        }
    }

    // -------- è§¦æ‘¸äº‹ä»¶ --------
    handleTouchStart(e) {
        e.preventDefault();
        this.audio.resume();
        const t = e.touches ? e.touches[0] : e;
        this.touchActive = true;
        this.targetX = t.clientX;
    }
    handleTouchMove(e) {
        e.preventDefault();
        if (!this.touchActive) return;
        const t = e.touches ? e.touches[0] : e;
        this.targetX = t.clientX;
    }
    handleTouchEnd(e) {
        e.preventDefault();
        this.touchActive = false;
    }
}

// ================================================================
//  åˆå§‹åŒ–
// ================================================================
const game = new Game();

// ç”Ÿæˆé€‰è½¦ç•Œé¢
(function buildSelectScreen() {
    const grid = document.getElementById('vehicleGrid');
    VEHICLES.forEach(v => {
        const card = document.createElement('div');
        card.className = 'vehicle-card';
        const iconHTML = v.cardIcon || '<div class="v-emoji">' + v.emoji + '</div>';
        card.innerHTML = iconHTML + '<div class="v-name">' + v.name + '</div>';
        const startGame = (e) => {
            e.preventDefault();
            e.stopPropagation();
            game.start(v);
        };
        card.addEventListener('touchstart', startGame, { passive: false });
        card.addEventListener('mousedown', startGame);
        grid.appendChild(card);
    });
})();

// æ¢å¤ä¸Šæ¬¡é€‰æ‹©çš„é«˜äº®ï¼ˆå¯é€‰ï¼‰
try {
    const last = localStorage.getItem('dabing_travel_lastVehicle');
    if (last) {
        const cards = document.querySelectorAll('.vehicle-card');
        VEHICLES.forEach((v, i) => {
            if (v.id === last && cards[i]) {
                cards[i].style.boxShadow = '0 0 0 0.8vmin #FF6B9D, 0 1vmin 3vmin rgba(0,0,0,0.15)';
            }
        });
    }
} catch(e) {}

// æ¸¸æˆè§¦æ‘¸äº‹ä»¶ç»‘å®š
const canvas = document.getElementById('gameCanvas');
canvas.addEventListener('touchstart', (e) => game.handleTouchStart(e), { passive: false });
canvas.addEventListener('touchmove', (e) => game.handleTouchMove(e), { passive: false });
canvas.addEventListener('touchend', (e) => game.handleTouchEnd(e), { passive: false });
// é¼ æ ‡å…¼å®¹ï¼ˆæ¡Œé¢æµ‹è¯•ï¼‰
canvas.addEventListener('mousedown', (e) => game.handleTouchStart(e));
canvas.addEventListener('mousemove', (e) => { if (game.touchActive) game.handleTouchMove(e); });
canvas.addEventListener('mouseup', (e) => game.handleTouchEnd(e));

// é”®ç›˜æ”¯æŒï¼ˆç”µè„‘ç«¯ï¼šå·¦å³é”® + ç©ºæ ¼æš‚åœï¼‰
document.addEventListener('keydown', (e) => {
    if (!game.running) return;
    if (e.key === 'ArrowLeft')  { game.keysDown.left = true;  e.preventDefault(); }
    if (e.key === 'ArrowRight') { game.keysDown.right = true; e.preventDefault(); }
    if (e.key === ' ' || e.key === 'p' || e.key === 'P') { game.togglePause(); e.preventDefault(); }
});
document.addEventListener('keyup', (e) => {
    if (e.key === 'ArrowLeft')  game.keysDown.left = false;
    if (e.key === 'ArrowRight') game.keysDown.right = false;
});

// éŸ³ä¹æŒ‰é’®
const musicBtn = document.getElementById('musicBtn');
musicBtn.addEventListener('touchstart', (e) => {
    e.preventDefault(); e.stopPropagation();
    const on = game.audio.toggleBGM();
    musicBtn.textContent = on ? 'ğŸ”Š' : 'ğŸ”‡';
}, { passive: false });
musicBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    const on = game.audio.toggleBGM();
    musicBtn.textContent = on ? 'ğŸ”Š' : 'ğŸ”‡';
});

// æš‚åœæŒ‰é’®
const pauseBtn = document.getElementById('pauseBtn');
const pauseOverlay = document.getElementById('pauseOverlay');
const handlePause = (e) => { e.preventDefault(); e.stopPropagation(); game.togglePause(); };
pauseBtn.addEventListener('touchstart', handlePause, { passive: false });
pauseBtn.addEventListener('click', handlePause);
pauseOverlay.addEventListener('touchstart', (e) => {
    e.preventDefault(); e.stopPropagation();
    if (game.paused) game.togglePause();
}, { passive: false });
pauseOverlay.addEventListener('click', (e) => {
    e.stopPropagation();
    if (game.paused) game.togglePause();
});

// è¿”å›æŒ‰é’®ï¼ˆé•¿æŒ‰ 1 ç§’ï¼‰
const homeBtn = document.getElementById('homeBtn');
let homePressTimer = null;
const homeStart = (e) => {
    e.preventDefault(); e.stopPropagation();
    homePressTimer = setTimeout(() => { game.stop(); }, 1000);
};
const homeEnd = (e) => {
    e.preventDefault(); e.stopPropagation();
    if (homePressTimer) { clearTimeout(homePressTimer); homePressTimer = null; }
};
homeBtn.addEventListener('touchstart', homeStart, { passive: false });
homeBtn.addEventListener('touchend', homeEnd, { passive: false });
homeBtn.addEventListener('mousedown', homeStart);
homeBtn.addEventListener('mouseup', homeEnd);
homeBtn.addEventListener('mouseleave', homeEnd);
</script>
</body>
</html>
